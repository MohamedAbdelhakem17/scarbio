name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SCARBIO_SSH_HOST }}
          username: ${{ secrets.SCARBIO_USER_KEY }}
          key: ${{ secrets.SCARBIO_SSH_KEY }}
          script: |
            set -e
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ SCARBIO DEPLOYMENT STARTED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

            echo "ğŸ”„ [GIT] Fetching latest changes from origin..."
            cd /var/www/scarbio
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ“¦ [CLIENT] Navigating to client directory..."
            cd /var/www/scarbio/client

            echo "â¬‡ï¸  [CLIENT] Installing dependencies..."
            npm install

            echo "ğŸ”¨ [CLIENT] Building application..."
            npm run build

            echo "â–¶ï¸  [CLIENT] Starting application..."
            npm run start

            echo "â™»ï¸  [CLIENT] Restarting PM2 process 'scarbio'..."
            pm2 restart scarbio
            echo "âœ… [CLIENT] Deployment completed successfully!"
            echo ""

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            echo "ğŸ“¦ [SERVER] Navigating to server directory..."
            cd ../server

            echo "â¬‡ï¸  [SERVER] Installing dependencies..."
            npm install

            echo "ğŸ”¨ [SERVER] Building application..."
            npm run build

            echo "â™»ï¸  [SERVER] Restarting PM2 process 'scarbio-api'..."
            pm2 restart scarbio-api
            echo "âœ… [SERVER] Deployment completed successfully!"
            echo ""

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
